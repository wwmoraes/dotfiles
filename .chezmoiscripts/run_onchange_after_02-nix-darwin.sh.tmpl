#!/usr/bin/env sh
# chezmoi:template:left-delimiter="#{{" right-delimiter=}}
# darwin-configuration.nix hash: #{{ include (joinPath .chezmoi.homeDir ".nixpkgs" "darwin-configuration.nix") | sha256sum }}
#{{- if .environment.home }}
# home-configuration.nix hash: #{{ include (joinPath .chezmoi.homeDir ".nixpkgs" "darwin" "home-configuration.nix") | sha256sum }}
#{{- else if .environment.work }}
# work-configuration.nix hash: #{{ include (joinPath .chezmoi.homeDir ".nixpkgs" "darwin" "work-configuration.nix") | sha256sum }}
#{{- end }}
#{{- range $_, $filename := (glob (joinPath .chezmoi.homeDir ".nixpkgs" "scripts" "*")) }}
# #{{ base $filename }} hash: #{{ include $filename | sha256sum }}
#{{- end }}

set -eum
trap 'kill 0' INT HUP TERM

test "${TRACE:-0}" = "1" && set -x
test "${VERBOSE:-0}" = "1" && set -v

printf "\e[1;33m[Darwin] Nix-darwin\e[0m\n"

# run only on darwin
test "${CHEZMOI_OS:-}" = "darwin" || exit

# skip if nix-darwin is installed
if [ ! -f /run/current-system/sw/bin/darwin-version ]; then
	TMP=$(mktemp -d)
	OLD_PWD="${PWD}"
	cd "${TMP}" || exit
	trap 'cd "${OLD_PWD}"; rm -rf "${TMP}"' EXIT

	nix-channel --add https://github.com/nix-darwin/nix-darwin/archive/nix-darwin-25.05.tar.gz darwin
fi

systemConfig=$(nix-build '<darwin>' \
	--show-trace \
	--no-out-link \
	-A system)
nix-env -p /nix/var/nix/profiles/system --set "${systemConfig}"
sudo "${systemConfig}/activate"
