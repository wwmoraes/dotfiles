#!/usr/bin/env sh

set -eum
trap 'kill 0' INT HUP TERM

chezmoi apply ~/.config/nix ~/.config/nixpkgs ~/.nixpkgs

profile=/nix/var/nix/profiles/system

echo "building the system configuration..." >&2
systemConfig=$(nix-build '<darwin>' --show-trace --no-out-link -A system)

nix-env -p "${profile}" --set "${systemConfig}"
sudo "${systemConfig}/activate"
